## Filtering vcf generated by Gencove using GATK

## sort vcf - required a lot of memory 
bedtools sort -i unfiltered.vcf.gz > unfiltered_sorted.vcf

## sort mappability file
bedtools sort -i snowleopard-111120.FINAL.DC2.leoY.mappability.1.0.bed > snowleopard-111120.FINAL.DC2.leoY.mappability.1.0_sorted.bed

## retain only portions of vcf that fall within regions of the genome with a mappability score of 1
bedtools intersect -a unfiltered_sorted_wHeader.vcf -b snowleopard-111120.FINAL.DC2.leoY.mappability.1.0_sorted.bed -v -header -sorted > GencoveVCF_mappability100.vcf

## remove indels
vcftools --vcf GencoveVCF_mappability100.vcf --out GencoveVCF_mappability100_noIndel --remove-indels --recode

## rename individuals
zcat GencoveVCF_mappability100_noIndel.recode.vcf.gz | sed -e 's/18032-95-N707S515_S112_L008/MSB_M1/g' | sed -e 's/18032-95-N707S516_S113_L008/MSB_F1/g' | sed -e 's/18032FL-100-01_S1469_L007/SL_Mong_M1/g' | sed -e 's/18032FL-100-02_S1470_L007/SL_Mong_M9/g' | sed -e 's/18032FL-100-03_S1471_L007/SL_Mong_F8/g' | sed -e 's/18032FL-100-04_S1472_L007/SL_Mong_F9/g' | sed -e 's/18032FL-100-05_S1473_L007/SL_Mong_M10/g' | sed -e 's/18032FL-104-N715S508_S213_L004/SL_M11136_Bronx/g' | sed -e 's/18032FL-52-01-SI-GA-E4_ALL/10X_SDzoo/g' | sed -e 's/18032FL-74-01-01_S13_L002/SL_KGZ_M1/g' | sed -e 's/18032FL-74-01-02_S14_L002/SL_KGZ_F4/g' | sed -e 's/18032FL-74-01-03_S15_L002/SL_KGZ_M2/g' | sed -e 's/18032FL-74-01-04_S16_L002/SL_KGZ_M3/g' | sed -e 's/18032FL-74-01-05_S17_L002/SL_KGZ_F1/g' | sed -e 's/18032FL-74-01-06_S18_L002/SL_KGZ_F3/g' | sed -e 's/18032FL-74-01-07_S19_L002/SL_KGZ_F2/g' | sed -e 's/18032FL-99-02-01_S45_L004/U01/g' | sed -e 's/18032FL-99-03-01_S46_L004/U02/g' | sed -e 's/18032FL-99-05-01_S48_L004/U04/g' | sed -e 's/18032FL-99-06-01_S49_L004/U05/g' | sed -e 's/18032FL-99-07-01_S50_L004/U06/g' | sed -e 's/18032FL-99-08-01_S51_L004/U07/g' | sed -e 's/18032FL-99-09-01_S52_L004/U08/g' | sed -e 's/18032FL-99-10-01_S53_L004/U09/g' | sed -e 's/18032FL-99-11-01_S54_L004/U10/g' | sed -e 's/18032FL-99-12-01_S55_L004/U11/g' | sed -e 's/18032FL-99-13-01_S56_L004/U12/g' | sed -e 's/18032FL-99-14-01_S57_L004/U13/g' | sed -e 's/18032FL-99-15-01_S58_L004/U14/g' | sed -e 's/18032FL-99-16-01_S59_L004/U15/g'| sed -e 's/18032FL-99-17-01_S60_L004/U20/g' | sed -e 's/AF_SL_05/AF_SL_05/g' | sed -e 's/AF_SL_06/AF_SL_06/g' | sed -e 's/AF_SL_07/AF_SL_07/g' | sed -e 's/AF_SL_08/AF_SL_08/g' | sed -e 's/Leo/Leo/g' | sed -e 's/Puncia-34/India_NCBS/g' | sed -e 's/SRR12437590/DNAzoo/g' | sed -e 's/SRR836372.1/Mong_SRR836372/g' | sed -e 's/18032-95-N707S513_S111_L008/PA_Zoo/g' | sed -e 's/18032FL-99-04-01_S47_L004/U03/g' > GencoveVCF_mappability100_noIndel_IndRename.recode.vcf

## remove samples U02, U12, U20
vcftools --vcf GencoveVCF_mappability100_noIndel_IndRename.recode.vcf --out GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20 --remove-indv U02 --remove-indv U12 --remove-indv U20 --recode

## remove SNPs that are no longer variable 
vcftools --vcf GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20.recode.vcf --out GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef --non-ref-ac-any 1 --recode


## keep only SNPs on autosomes
vcftools --vcf GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef.recode.vcf --out GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_autosomes --chr HiC_scaffold_16 --chr HiC_scaffold_17 --chr HiC_scaffold_5 --chr HiC_scaffold_11 --chr HiC_scaffold_12 --chr HiC_scaffold_18 --chr HiC_scaffold_25 --chr HiC_scaffold_2 --chr HiC_scaffold_1 --chr HiC_scaffold_20 --chr HiC_scaffold_8 --chr HiC_scaffold_13 --chr HiC_scaffold_7 --chr HiC_scaffold_15 --chr HiC_scaffold_14 --chr HiC_scaffold_3 --chr HiC_scaffold_9 --chr HiC_scaffold_22 --chr HiC_scaffold_10 --chr HiC_scaffold_19 --chr HiC_scaffold_23 --chr HiC_scaffold_24 --chr HiC_scaffold_21 --chr HiC_scaffold_4 --recode

## split chromosome 22 at bp 67650000
grep 'HiC_scaffold_22' GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_autosomes.recode.vcf > GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_chrE1_F1.txt
head -74069 GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_chrE1_F1.txt > GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_chrE1.txt
tail -74652 GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_chrE1_F1.txt > GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_chrF1.txt
cat GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_chrE1.txt | sed -e 's/HiC_scaffold_22/HiC_scaffold_22_E1/g' > GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_chrE1_reName.txt
cat GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_chrF1.txt | sed -e 's/HiC_scaffold_22/HiC_scaffold_22_F1/g' > GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_chrF1_reName.txt
grep -vw 'HiC_scaffold_22' GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_autosomes.recode.vcf > GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_autosomes_noscaffold22.vcf
grep -vw '#' GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_autosomes_noscaffold22.vcf > GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_autosomes_noscaffold22_noheader.vcf
grep '#' GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_autosomes.recode.vcf > GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_header.txt
>>>>add these lines to the header
##contig=<ID=HiC_scaffold_22_E1,length=67650000,assembly=unknown>
##contig=<ID=HiC_scaffold_22_F1,length=129484490,assembly=unknown>
cat GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_header.txt GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_autosomes_noscaffold22_noheader.vcf GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_chrE1_reName.txt GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_chrF1_reName.txt > GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_autosomes_scaff22Split.vcf

## retain only biallelic SNPs
vcftools --vcf GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_autosomes_scaff22Split.vcf --out GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_autosomes_scaff22Split_biallelic --min-alleles 2 --max-alleles 2 --recode
