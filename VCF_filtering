## Filtering vcf generated by Gencove using GATK

## sort vcf - required a lot of memory 
bedtools sort -i unfiltered.vcf.gz > unfiltered_sorted.vcf

## make file with just vcf header lines
zcat unfiltered.vcf.gz | grep '#' > unfiltered_header.txt

##add header back to sorted vcf
cat unfiltered_header.txt unfiltered_sorted.vcf > unfiltered_sorted_wheader.vcf

## sort mappability file
bedtools sort -i snowleopard-111120.FINAL.DC2.leoY.mappability.1.0.bed > snowleopard-111120.FINAL.DC2.leoY.mappability.1.0_sorted.bed

## retain only portions of vcf that fall within regions of the genome with a mappability score of 1
bedtools intersect -a unfiltered_sorted_wheader.vcf -b ../../../snowleopard-111120.FINAL.DC2.leoY.mappability.1.0_sorted.bed -v -header -sorted > unfiltered_sorted_mappability100.vcf

## remove samples U02, U12, U20 and indels
vcftools --vcf unfiltered_sorted_mappability100.vcf --out unfiltered_sorted_mappability100_noU02_12_20_noIndel --remove-indv 18032FL-99-03-01_S46_L004 --remove-indv 18032FL-99-13-01_S56_L004 --remove-indv 18032FL-99-17-01_S60_L004  --remove-indels --recode --recode-INFO-all

## remove SNPs that are no longer variable 
vcftools --vcf unfiltered_sorted_mappability100_noU02_12_20_noIndel.recode.vcf --out unfiltered_sorted_mappability100_noU02_12_20_noIndel_1nonRef --non-ref-ac-any 1 --recode --recode-INFO-all

## keep only SNPs on autosomes
vcftools --vcf unfiltered_sorted_mappability100_noU02_12_20_noIndel_1nonRef.recode.vcf --out unfiltered_sorted_mappability100_noU02_12_20_noIndel_1nonRef_autosomes --chr HiC_scaffold_16 --chr HiC_scaffold_17 --chr HiC_scaffold_5 --chr HiC_scaffold_11 --chr HiC_scaffold_12 --chr HiC_scaffold_18 --chr HiC_scaffold_25 --chr HiC_scaffold_2 --chr HiC_scaffold_1 --chr HiC_scaffold_20 --chr HiC_scaffold_8 --chr HiC_scaffold_13 --chr HiC_scaffold_7 --chr HiC_scaffold_15 --chr HiC_scaffold_14 --chr HiC_scaffold_3 --chr HiC_scaffold_9 --chr HiC_scaffold_22 --chr HiC_scaffold_10 --chr HiC_scaffold_19 --chr HiC_scaffold_23 --chr HiC_scaffold_24 --chr HiC_scaffold_21 --chr HiC_scaffold_4 --recode --recode-INFO-all

## retain only biallelic SNPs
vcftools --vcf unfiltered_sorted_mappability100_noU02_12_20_noIndel_1nonRef_autosomes.recode.vcf --out unfiltered_sorted_mappability100_noU02_12_20_noIndel_1nonRef_autosomes_biallelic --min-alleles 2 --max-alleles 2 --recode --recode-INFO-all

##Filter with GATK
gatk VariantFiltration --filter-expression "QD < 2.0 || FS > 60.0 || MQ < 40.0 || MQRankSum < -12.5 || ReadPosRankSum < -8.0" -V unfiltered_sorted_mappability100_noU02_12_20_noIndel_1nonRef_autosomes_biallelic.recode.vcf -O unfiltered_sorted_mappability100_noU02_12_20_noIndel_1nonRef_autosomes_biallelic_gatkFilt.vcf --filter-name LOWQUAL
vcftools --vcf unfiltered_sorted_mappability100_noU02_12_20_noIndel_1nonRef_autosomes_biallelic_gatkFilt.vcf --out unfiltered_sorted_mappability100_noU02_12_20_noIndel_1nonRef_autosomes_biallelic_gatkFilt_pass --remove-filtered-all --recode --recode-INFO-all

##remove SNPs with data missing in more than 10% of individuals
vcftools --vcf unfiltered_sorted_mappability100_noU02_12_20_noIndel_1nonRef_autosomes_biallelic_gatkFilt_pass.recode.vcf --out unfiltered_sorted_mappability100_noU02_12_20_noIndel_1nonRef_autosomes_biallelic_gatkFilt_pass_90maxmis --max-missing 0.9 --recode --recode-INFO-all


## split chromosome 22 at bp 67650000
grep 'HiC_scaffold_22' GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_autosomes.recode.vcf > GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_chrE1_F1.txt
head -74069 GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_chrE1_F1.txt > GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_chrE1.txt
tail -74652 GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_chrE1_F1.txt > GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_chrF1.txt
cat GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_chrE1.txt | sed -e 's/HiC_scaffold_22/HiC_scaffold_22_E1/g' > GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_chrE1_reName.txt
cat GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_chrF1.txt | sed -e 's/HiC_scaffold_22/HiC_scaffold_22_F1/g' > GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_chrF1_reName.txt
grep -vw 'HiC_scaffold_22' GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_autosomes.recode.vcf > GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_autosomes_noscaffold22.vcf
grep -vw '#' GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_autosomes_noscaffold22.vcf > GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_autosomes_noscaffold22_noheader.vcf
grep '#' GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_autosomes.recode.vcf > GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_header.txt
>>>>add these lines to the header
##contig=<ID=HiC_scaffold_22_E1,length=67650000,assembly=unknown>
##contig=<ID=HiC_scaffold_22_F1,length=129484490,assembly=unknown>
cat GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_header.txt GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_autosomes_noscaffold22_noheader.vcf GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_chrE1_reName.txt GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_chrF1_reName.txt > GencoveVCF_mappability100_noIndel_IndRename_noU02_12_20_1nonRef_autosomes_scaff22Split.vcf

